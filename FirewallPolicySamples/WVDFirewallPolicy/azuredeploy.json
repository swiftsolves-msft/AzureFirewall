{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "firewallPolicyName": {
            "defaultValue": "WVDFirewallPolicy",
            "type": "String"
        },
        "WVDHostPoolSubnetCidr": {
            "metadata": {
                "description": "The WVD HostPool Subnet Address with CIDR xx.xx.xx.xx/yy. This will be used in the source address of the Azure Firewall network and app rules"
            },
            "type": "String"
        },
        "AD_DNSServers": {
            "metadata": {
                "description": "Array of AD DNS Servers the WVD Host Pool can communicate over DNS xx.xx.xx.xx "
            },
            "type": "Array"
        },
        "ThreatIntelMode": {
            "metadata": {
                "description": "Threat Intellengence Mode traffic passing hits these rules first and have the following actions Off, Alert, Deny"
            },
            "defaultValue": "Alert",
            "allowedValues": [
                "Off",
                "Alert",
                "Deny"
            ],
            "type": "String"
        },
        "WVDServiceBusURLs": {
            "metadata": {
                "description": "Array of The WVD ServiceBus URLs this must be looked up as it is unique per instance EX. gsmUNIQUESTRINGeh.servicebus.windows.net/* "
            },
            "type": "Array"
        },
        "WVDBlobURLs": {
            "metadata": {
                "description": "Array of The WVD Blob URLs this must be looked up as it is unique per instance EX. gsmUNIQUESTRINGxt.blob.core.windows.net/* "
            },
            "type": "Array"
        },
        "WVDTableURLs": {
            "metadata": {
                "description": "Array of The WVD Table URLs this must be looked up as it is unique per instance EX. gsmUNIQUESTRINGxt.blob.core.windows.net/* "
            },
            "type": "Array"
        },
        "WVDQueueURLs": {
            "metadata": {
                "description": "Array of The WVD Queue URLs this must be looked up as it is unique per instance EX. gsmUNIQUESTRINGxt.blob.core.windows.net/* "
            },
            "type": "Array"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Network/firewallPolicies",
            "apiVersion": "2020-05-01",
            "name": "[parameters('firewallPolicyName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "sku": {"tier": "Premium"},
                "threatIntelMode": "[parameters('ThreatIntelMode')]",
                "threatIntelWhitelist": {
                    "ipAddresses": []
                },
                "dnsSettings": {
                    "servers": [],
                    "enableProxy": true
                }
            }
        },
        {
            "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
            "apiVersion": "2020-05-01",
            "name": "[concat(parameters('firewallPolicyName'), '/DefaultApplicationRuleCollectionGroup')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
            ],
            "properties": {
                "priority": 300,
                "ruleCollections": [
                    {
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "action": {
                            "type": "Allow"
                        },
                        "rules": [
                            {
                                "ruleType": "ApplicationRule",
                                "name": "AllowWVDTag",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [
                                    "WindowsVirtualDesktop"
                                ],
                                "targetFqdns": [],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                            },
                            {
                                "ruleType": "ApplicationRule",
                                "name": "AllowWVDServicebus",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [],
                                "targetUrls": "[parameters('WVDServiceBusURLs')]",
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                            },
                            {
                                "ruleType": "ApplicationRule",
                                "name": "AllowWVDBlob",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [],
                                "targetUrls": "[parameters('WVDBlobURLs')]",
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                            },
                            {
                                "ruleType": "ApplicationRule",
                                "name": "AllowWVDTable",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [],
                                "targetUrls": "[parameters('WVDTableURLs')]",
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                            },
                            {
                                "ruleType": "ApplicationRule",
                                "name": "AllowWVDQueue",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [],
                                "targetUrls": "[parameters('WVDQueueURLs')]",
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                            }
                        ],
                        "name": "AllowAltWVD",
                        "priority": 200
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
            "apiVersion": "2020-05-01",
            "name": "[concat(parameters('firewallPolicyName'), '/DefaultNetworkRuleCollectionGroup')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
            ],
            "properties": {
                "priority": 200,
                "ruleCollections": [
                    {
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "action": {
                            "type": "Allow"
                        },
                        "rules": [
                            {
                                "ruleType": "NetworkRule",
                                "name": "AllowADDNS",
                                "ipProtocols": [
                                    "TCP",
                                    "UDP"
                                ],
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": "[parameters('AD_DNSServers')]",
                                "destinationIpGroups": [],
                                "destinationFqdns": [],
                                "destinationPorts": [
                                    "53"
                                ]
                            },
                            {
                                "ruleType": "NetworkRule",
                                "name": "AllowAzureKMS",
                                "ipProtocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [],
                                "destinationIpGroups": [],
                                "destinationFqdns": [
                                    "kms.core.windows.net"
                                ],
                                "destinationPorts": [
                                    "1688"
                                ]
                            },
                            {
                                "ruleType": "NetworkRule",
                                "name": "AllowWindowsNTP",
                                "ipProtocols": [
                                    "UDP"
                                ],
                                "sourceAddresses": [
                                    "[parameters('WVDHostPoolSubnetCidr')]"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [],
                                "destinationIpGroups": [],
                                "destinationFqdns": [
                                    "time.windows.com"
                                ],
                                "destinationPorts": [
                                    "123"
                                ]
                            }
                        ],
                        "name": "AllowAdditionalWVDNetwork",
                        "priority": 100
                    }
                ]
            }
        }
    ]
}
